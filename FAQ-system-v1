#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>

// ===== LCD =====
LiquidCrystal_I2C lcd(0x27, 20, 4);

// ===== Buttons =====
#define UP_BTN D5
#define DOWN_BTN D6
#define SELECT_BTN D7

// ===== WiFi Info =====
const char* ssid = "Pixel3";
const char* password = "12345678";

ESP8266WebServer server(80);

// ===== Questions =====
String questions[10] = {
  "Q1: What is DIU?",
  "Q2: How to get ID Card?",
  "Q3: How to check Routine?",
  "Q4:WiFi Password?",
  "Q5: Where is Library?",
  "Q6: How to pay fees?",
  "Q7: What is CSE office time?",
  "Q8: How to join clubs?",
  "Q9: How to get transport?",
  "Q10: How to contact dept?"
};

String answers[10] = {
  "DIU stands for Daffodil International University.",
  "You can collect your ID card from the Registrar Office. ",
  "Check your routine through DIU Smart App or visit the notice board.",
  "Connect DIU_Smart City :- diu123456789",
  "The library is located at Daffodil Tower building, 4th floor (AB4).",
  "You can pay fees through 1card App, online banking and accounts.",
  "8:00 AM to 5:00 PM, Sunday through Thursday. Friday and Saturday are closed.",
  "Visit the DSA office or check the club booths during orientation.",
  "Apply for transport facility through the Transport Section. ",
  "Visit the department or email your department head."
};

int viewCount[10] = {0};
int currentQuestion = 0;
bool showAnswer = false;

// ===== Display Functions =====
void showQuestion() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Select a Question:");
  lcd.setCursor(0, 1);
  lcd.print(questions[currentQuestion]);
}

void showAnswerText() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Answer:");
  lcd.setCursor(0, 1);
  String displayAnswer = answers[currentQuestion];
  if (displayAnswer.length() > 20) {
    lcd.print(displayAnswer.substring(0, 20));
    lcd.setCursor(0, 2);
    if (displayAnswer.length() > 40) {
      lcd.print(displayAnswer.substring(20, 40));
      lcd.setCursor(0, 3);
      lcd.print(displayAnswer.substring(40));
    } else {
      lcd.print(displayAnswer.substring(20));
    }
  } else {
    lcd.print(displayAnswer);
  }
}

// ===== Web Routes =====
void handleRoot() {
  String html = R"=====(
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIU FAQ System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .question-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .question-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-decoration: none;
            color: inherit;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .question-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .view-count {
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .navigation {
            text-align: center;
            margin-top: 20px;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }
        
        .answer-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .question-title {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .answer-text {
            color: #555;
            line-height: 1.6;
            font-size: 1.1rem;
            margin-bottom: 25px;
        }
        
        .meta-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .questions-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DIU FAQ System</h1>
            <p>Frequently Asked Questions - Daffodil International University</p>
        </div>
        
        <div class="card">
            <h2 style="color: #333; margin-bottom: 20px; text-align: center;">Frequently Asked Questions</h2>
            <div class="questions-grid">
  )=====";

  for (int i = 0; i < 10; i++) {
    html += "<a href='/question/" + String(i) + "' class='question-card'>";
    html += "<div class='question-number'>" + String(i + 1) + "</div>";
    html += "<div class='question-text'>" + questions[i] + "</div>";
    html += "<div class='view-count'>Views: " + String(viewCount[i]) + "</div>";
    html += "</a>";
  }

  html += R"=====(
            </div>
            
            <div class="navigation">
                <a href="/stats" class="btn">
                    View Statistics
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p>DIU FAQ System | Daffodil International University</p>
        </div>
    </div>
</body>
</html>
  )=====";

  server.send(200, "text/html", html);
}

void handleQuestion() {
  String path = server.uri();
  int qIndex = -1;
  
  // Extract question index from URL
  if (path.startsWith("/question/")) {
    qIndex = path.substring(10).toInt();
  }
  
  if (qIndex >= 0 && qIndex < 10) {
    viewCount[qIndex]++;
    currentQuestion = qIndex;
    showQuestion();

    String html = R"=====(
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question )=====" + String(qIndex + 1) + R"=====( - DIU FAQ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .answer-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .question-title {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .answer-text {
            color: #555;
            line-height: 1.7;
            font-size: 1.2rem;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .meta-info {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DIU FAQ Answer</h1>
            <p>Detailed answer to your question</p>
        </div>
        
        <div class="answer-container">
            <div class="question-title">)=====" + questions[qIndex] + R"=====(</div>
            
            <div class="answer-text">)=====" + answers[qIndex] + R"=====(</div>
            
            <div class="meta-info">
                <strong>Question Statistics:</strong><br>
                - This question has been viewed <strong>)=====" + String(viewCount[qIndex]) + R"=====( times</strong><br>
                - Question ID: )=====" + String(qIndex + 1) + R"=====(
            </div>
            
            <div class="navigation">
                <a href="/" class="btn">Back to All Questions</a>
                <a href="/stats" class="btn btn-secondary">View Statistics</a>
            </div>
        </div>
        
        <div class="footer">
            <p>DIU FAQ System | Daffodil International University</p>
        </div>
    </div>
</body>
</html>
    )=====";

    server.send(200, "text/html", html);
  } else {
    server.send(404, "text/plain", "Question not found");
  }
}

void handleStats() {
  String html = R"=====(
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Statistics - DIU</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .stats-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stats-header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }
        
        .stats-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: scale(1.05);
        }
        
        .stat-views {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 30px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .navigation {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FAQ Statistics</h1>
            <p>View count analysis for each question</p>
        </div>
        
        <div class="stats-container">
            <div class="stats-header">
                <h2>Question View Statistics</h2>
                <p>Total views for each frequently asked question</p>
            </div>
            
            <div class="stats-grid">
  )=====";

  for (int i = 0; i < 10; i++) {
    html += "<div class=\"stat-item\">";
    html += "<div class=\"stat-label\">Question " + String(i + 1) + "</div>";
    html += "<div class=\"stat-views\">" + String(viewCount[i]) + "</div>";
    html += "<div class=\"stat-label\">Views</div>";
    html += "</div>";
  }

  html += R"=====(
            </div>
            
            <div class="navigation">
                <a href="/" class="btn">Back to Questions</a>
            </div>
        </div>
    </div>
</body>
</html>
  )=====";

  server.send(200, "text/html", html);
}

// ===== Button Handler =====
void handleButtons() {
  if (digitalRead(UP_BTN) == LOW) {
    currentQuestion--;
    if (currentQuestion < 0) currentQuestion = 9;
    showQuestion();
    showAnswer = false;
    delay(250);
  }

  if (digitalRead(DOWN_BTN) == LOW) {
    currentQuestion++;
    if (currentQuestion > 9) currentQuestion = 0;
    showQuestion();
    showAnswer = false;
    delay(250);
  }

  if (digitalRead(SELECT_BTN) == LOW) {
    if (showAnswer) {
      showAnswer = false;
      showQuestion();
    } else {
      showAnswer = true;
      viewCount[currentQuestion]++;
      showAnswerText();
    }
    delay(300);
  }
}

// ===== Setup =====
void setup() {
  Serial.begin(115200);
  Wire.begin(D2, D1);
  lcd.init();
  lcd.backlight();
  lcd.print("Connecting WiFi...");

  pinMode(UP_BTN, INPUT_PULLUP);
  pinMode(DOWN_BTN, INPUT_PULLUP);
  pinMode(SELECT_BTN, INPUT_PULLUP);

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println();
  Serial.print("Connected! Local IP: ");
  Serial.println(WiFi.localIP());

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("WiFi Connected!");
  lcd.setCursor(0, 1);
  lcd.print(WiFi.localIP().toString());

  server.on("/", handleRoot);
  server.on("/question/0", handleQuestion);
  server.on("/question/1", handleQuestion);
  server.on("/question/2", handleQuestion);
  server.on("/question/3", handleQuestion);
  server.on("/question/4", handleQuestion);
  server.on("/question/5", handleQuestion);
  server.on("/question/6", handleQuestion);
  server.on("/question/7", handleQuestion);
  server.on("/question/8", handleQuestion);
  server.on("/question/9", handleQuestion);
  server.on("/stats", handleStats);
  server.begin();

  delay(2000);
  showQuestion();
}

// ===== Loop =====
void loop() {
  server.handleClient();
  handleButtons();
}
